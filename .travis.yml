dist: xenial
language: cpp
notifications:
  irc: "chat.freenode.net#xapian-devel"
env:
  global:
    - HOMEBREW_PACKAGES='doxygen help2man graphviz pngcrush libiconv libmagic pcre lua mono python2 python'
matrix:
  include:
    - compiler: gcc
      os: linux
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - doxygen
            - graphviz
            - help2man
            - python-docutils
            - pngcrush
            - python-sphinx
            - uuid-dev
            - libpcre3-dev
            - libmagic-dev
            - lua5.3
            - liblua5.3-dev
            - mono-devel
            - python-dev
            - python3-dev
            - tcl
            - gcc-4.7
            - g++-4.7
      # The PHP bindings fail to compile because they assume compiler builtins
      # which were available in the compiler used to build PHP are available
      # when build code using the PHP C API, so just disable them.
      env: USE_CC=gcc-4.7 USE_CXX=g++-4.7 CPPFLAGS=-D_GLIBCXX_DEBUG confargs='--without-php7'
    - compiler: clang
      os: linux
      # Clang is already installed, but we want to build using the
      # llvm c++ library, not the GCC one. (Otherwise, depending on
      # the GCC version, there can be issues.)
      addons:
        apt:
          packages:
            - doxygen
            - graphviz
            - help2man
            - python-docutils
            - pngcrush
            - python-sphinx
            - uuid-dev
            - libpcre3-dev
            - libmagic-dev
            - tcl
            - libc++-dev
      env: USE_CC=clang USE_CXX='clang++ -stdlib=libc++'
    - compiler: gcc
      os: linux
      # Test with trusty as it has GCC 4.8 which is the oldest GCC we currently
      # aim to support.
      dist: trusty
      addons:
        apt:
          packages:
            - doxygen
            - graphviz
            - help2man
            - python-docutils
            - pngcrush
            - python-sphinx
            - uuid-dev
            - libpcre3-dev
            - libmagic-dev
            - lua5.2
            - liblua5.2-dev
            - mono-devel
            - python-dev
            - python3-dev
            - tcl
            - libsvm-dev
    - os: osx
      before_install:
        - brew update
        # "brew install" unhelpfully errors out if any package listed is
        # already installed and up-to-date, but travis change what's installed
        # by default from time to time so it's brittle to just filter out those
        # installed by default from the list we need.  Instead we ignore the
        # exit status from "brew install", then check later that
        # "brew list --versions" says all the packages requested are installed.
        - brew install $HOMEBREW_PACKAGES || true
        - brew list --versions $HOMEBREW_PACKAGES
        - pip2 install sphinx docutils
        - pip3 install sphinx
      env: PYTHON2=/usr/local/bin/python2 confargs='--prefix=/Users/travis/XapianInstall --with-libiconv-prefix=/usr/local/opt/libiconv' installcore='make -C xapian-core install'
    - os: linux
      # (Ab)use env to label this build:
      env: dummy="Automated run of xapian-check-patch"
      # Override "before_script" to do nothing
      before_script:
      # Override "script" to run the style checking script
      # "xapian-check-patch":
      # * for a PR, CI is run on the PR branch merged with the target branch,
      #   so just check the diff from the target branch to that merged branch.
      # * Otherwise we check changes between the common ancestor of master and
      #   the branch and the revision being checked.
      script:
        - git diff `[ "$TRAVIS_PULL_REQUEST" = false ] && echo master... || echo "$TRAVIS_BRANCH.."`|xapian-maintainer-tools/xapian-check-patch


before_script:
  # Bootstrap everything, then configure using our chosen compiler.
  - ./bootstrap
  - ./configure $confargs CC="$USE_CC" CXX="$USE_CXX"
script:
  - make
  - $installcore
  - make check VERBOSE=1 AUTOMATED_TESTING=1
  # grep '^' passes through all input while giving a non-zero exit status if
  # that input is empty.
  - git status --porcelain|grep '^' && { echo "The generated files listed above are not in .gitignore" ; exit 1; }; true
